<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro EMS</title>
  <link rel="stylesheet" href="style.css">
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="ems_logo.png">
</head>

<body>
  <main>

    <!-- LOGIN -->
    <section id="loginDiv">
      <header>
        <h1>Registro EMS</h1>
      </header>
      <img src="ems_logo.png" alt="EMS Logo" width="150">
      <input type="text" id="nombre" placeholder="Ingresa tu nombre">
      <button onclick="login()" aria-label="Entrar al sistema">Entrar</button>
      <p id="errorMsg" style="color:#ff5555; margin-top:0.5rem;"></p>
    </section>

    <!-- CONTROL DIARIO -->
    <section id="controlDiv" style="display:none;">
      <h2>Bienvenido, <span id="userName"></span></h2>
      <button class="btn-entrada" onclick="marcarEntrada()" aria-label="Marcar entrada">ðŸŸ¢ Entrada</button>
      <button class="btn-salida" onclick="marcarSalida()" aria-label="Marcar salida">ðŸ”´ Salida</button>
      <button class="btn-resumen" onclick="mostrarVistaResumen()" aria-label="Ver resumen">ðŸ“Š Resumen Semana /
        Mes</button>

      <h3>Registros de hoy</h3>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Entrada</th>
            <th>Salida</th>
            <th>Horas del turno</th>
          </tr>
        </thead>
        <tbody id="registrosBody"></tbody>
      </table>

      <div style="margin-top:1rem;">
        <p>Horas esta semana: <span id="horasSemana">0</span></p>
        <p>Horas este mes: <span id="horasMes">0</span></p>
      </div>
      <button class="btn-salir" onclick="salir()">Salir</button>
    </section>

    <!-- RESUMEN SEMANAL / MENSUAL -->
    <section id="resumenDiv">
      <button onclick="volverRegistro()" aria-label="Volver a registro diario">Volver a Registro Diario</button>

      <h3>Resumen Semanal</h3>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Horas Semana</th>
          </tr>
        </thead>
        <tbody id="tbodySemana"></tbody>
      </table>

      <h3>Resumen Mensual</h3>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Horas Mes</th>
          </tr>
        </thead>
        <tbody id="tbodyMes"></tbody>
      </table>
    </section>

    <script>
      let user = null;

      async function login() {
        const nombre = document.getElementById("nombre").value.trim();
        const errorMsg = document.getElementById("errorMsg");
        errorMsg.textContent = "";
        if (!nombre) {
          errorMsg.textContent = "Ingresa tu nombre";
          return;
        }

        try {
          const res = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nombre })
          });
          user = await res.json();
          document.getElementById("userName").textContent = user.nombre;
          document.getElementById("loginDiv").style.display = "none";
          document.getElementById("controlDiv").style.display = "block";
          cargarRegistrosHoy();
          actualizarContadores();
        } catch (err) {
          console.error(err);
          errorMsg.textContent = "Error al iniciar sesiÃ³n";
        }
      }

      async function marcarEntrada() {
        if (!user) return;
        await fetch("/entrada", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: user._id })
        });
        cargarRegistrosHoy();
        actualizarContadores();
      }

      async function marcarSalida() {
        if (!user) return;
        await fetch("/salida", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: user._id })
        });
        cargarRegistrosHoy();
        actualizarContadores();
      }

      function calcularHoras(entrada, salida) {
        if (!entrada || !salida) return 0;
        return ((new Date(salida) - new Date(entrada)) / 1000 / 60 / 60).toFixed(2);
      }

      async function cargarRegistrosHoy() {
        const res = await fetch("/registros");
        const registros = await res.json();
        const tbody = document.getElementById("registrosBody");
        tbody.innerHTML = "";
        const hoy = new Date().toDateString();
        registros.filter(r => new Date(r.entrada).toDateString() === hoy)
          .forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${r.nombre}</td>
                          <td>${new Date(r.entrada).toLocaleTimeString()}</td>
                          <td>${r.salida ? new Date(r.salida).toLocaleTimeString() : "-"}</td>
                          <td>${calcularHoras(r.entrada, r.salida)}</td>`;
            tbody.appendChild(tr);
          });
      }

      async function actualizarContadores() {
        if (!user) return;
        const resSemana = await fetch(`/contador-semanal/${user._id}`);
        const dataSemana = await resSemana.json();
        document.getElementById("horasSemana").textContent = dataSemana.horas;

        const resMes = await fetch(`/contador-mensual/${user._id}`);
        const dataMes = await resMes.json();
        document.getElementById("horasMes").textContent = dataMes.horas;
      }

      async function mostrarVistaResumen() {
        document.getElementById("controlDiv").style.display = "none";
        document.getElementById("resumenDiv").style.display = "block";

        const [resSemana, resMes] = await Promise.all([
          fetch("/resumen-semanal"),
          fetch("/resumen-mensual")
        ]);

        const resumenSemana = await resSemana.json();
        const resumenMes = await resMes.json();

        const tbodySemana = document.getElementById("tbodySemana");
        const tbodyMes = document.getElementById("tbodyMes");
        tbodySemana.innerHTML = "";
        tbodyMes.innerHTML = "";

        resumenSemana.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.nombre}</td><td>${r.horas}</td>`;
          tbodySemana.appendChild(tr);
        });

        resumenMes.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.nombre}</td><td>${r.horas}</td>`;
          tbodyMes.appendChild(tr);
        });
      }

      function volverRegistro() {
        document.getElementById("resumenDiv").style.display = "none";
        document.getElementById("controlDiv").style.display = "block";
        cargarRegistrosHoy();
        actualizarContadores();
      }

      window.onload = () => {
        cargarRegistrosHoy();
        actualizarContadores();
      }

      function salir() {
        // Ocultar control y resumen
        document.getElementById("controlDiv").style.display = "none";
        document.getElementById("resumenDiv").style.display = "none";

        // Mostrar login
        document.getElementById("loginDiv").style.display = "block";

        // Limpiar campo de nombre y variable user
        document.getElementById("nombre").value = "";
        user = null;
      }
    </script>
  </main>
</body>

</html>