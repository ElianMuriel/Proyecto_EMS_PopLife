<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro EMS</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background:#f5f5f5; }
  header { background:#333; color:white; padding:1rem; text-align:center; }
  main { padding:1rem; max-width:600px; margin: auto; }
  input, button { padding:0.5rem; margin:0.3rem 0; width:100%; box-sizing:border-box; }
  table { width:100%; border-collapse: collapse; margin-top:1rem; }
  th, td { padding:0.5rem; border:1px solid #ccc; text-align:left; }
  @media (max-width:600px){
    th, td { font-size:0.9rem; }
    button, input { font-size:1rem; }
  }
</style>
</head>
<body>
<header>
  <h1>Registro EMS</h1>
</header>

<main>
  <div id="loginDiv">
    <input type="text" id="nombre" placeholder="Ingresa tu nombre">
    <button onclick="login()">Entrar</button>
  </div>

  <div id="controlDiv" style="display:none;">
    <h2>Bienvenido, <span id="userName"></span></h2>
    <button onclick="marcarEntrada()">Registrar Entrada</button>
    <button onclick="marcarSalida()">Registrar Salida</button>

    <div style="margin-top:1rem;">
      <p>Horas esta semana: <span id="horasSemana">0</span></p>
      <p>Horas este mes: <span id="horasMes">0</span></p>
    </div>

    <h3>Registros</h3>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Entrada</th>
          <th>Salida</th>
        </tr>
      </thead>
      <tbody id="registrosBody"></tbody>
    </table>
  </div>
</main>

<script>
let user = null;

async function login(){
  const nombre = document.getElementById("nombre").value.trim();
  if(!nombre){ alert("Ingresa tu nombre"); return; }

  try{
    const res = await fetch("/login", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({nombre})
    });
    user = await res.json();
    document.getElementById("userName").textContent = user.nombre;
    document.getElementById("loginDiv").style.display = "none";
    document.getElementById("controlDiv").style.display = "block";
    cargarRegistros();
    actualizarContadores();
  }catch(err){
    console.error(err);
    alert("Error al iniciar sesiÃ³n");
  }
}

async function marcarEntrada(){
  if(!user) return;
  await fetch("/entrada", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({userId:user._id})
  });
  cargarRegistros();
  actualizarContadores();
}

async function marcarSalida(){
  if(!user) return;
  await fetch("/salida", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({userId:user._id})
  });
  cargarRegistros();
  actualizarContadores();
}

async function cargarRegistros(){
  const res = await fetch("/registros");
  const registros = await res.json();
  const tbody = document.getElementById("registrosBody");
  tbody.innerHTML = "";
  registros.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.nombre}</td>
                    <td>${r.entrada ? new Date(r.entrada).toLocaleString() : ""}</td>
                    <td>${r.salida ? new Date(r.salida).toLocaleString() : ""}</td>`;
    tbody.appendChild(tr);
  });
}

async function actualizarContadores(){
  if(!user) return;

  const resSemana = await fetch(`/contador-semanal/${user._id}`);
  const dataSemana = await resSemana.json();
  document.getElementById("horasSemana").textContent = dataSemana.horas;

  const resMes = await fetch(`/contador-mensual/${user._id}`);
  const dataMes = await resMes.json();
  document.getElementById("horasMes").textContent = dataMes.horas;
}
</script>
</body>
</html>
